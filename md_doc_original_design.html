<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ipfs-chromium: Changes/Additions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ipfs-chromium
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Changes/Additions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ol type="1">
<li>Outside of components/ipfs<ol type="a">
<li>chrome/browser gains a dependency on components/ipfs<ol type="i">
<li>Other apps may opt in as well.</li>
</ol>
</li>
<li>In ChromeContentBrowserClient::WillCreateURLLoaderRequestInterceptors<ol type="i">
<li>Instantiate an ipfs::Interceptor and add it to the list.</li>
</ol>
</li>
<li>ipfs:// and ipns:// URLs should be recongized in the omnibar</li>
</ol>
</li>
<li>New component "ipfs" contains classes:<ol type="a">
<li>URLLoaderRequestInterceptor<ol type="i">
<li>Checks the scheme against ipfs/ipns to decide whether to intercept</li>
<li>Creates Loader for each IPFS/IPNS request</li>
</ol>
</li>
<li>Gateways - maintains a list of known http gateways<ol type="i">
<li>Some are hard-coded</li>
<li>An embedder has the option to add more</li>
<li>Possible future work<ol type="A">
<li>Browser settings for end-users to manage gateway list</li>
<li>Zeroconf</li>
</ol>
</li>
<li>Maintains dynamic scoring of gateways based on performance</li>
<li>get_list() generates an ordered (prioritized) list to be used for a given request<ol type="A">
<li>The specific algo could be configured and/or extended</li>
</ol>
</li>
</ol>
</li>
<li>A URLLoader for ipfs:// and ipns:// URLs<ol type="i">
<li>Currently most of the actual mechanism is planned to go here</li>
<li>Could be further decomposed</li>
</ol>
</li>
<li>Data validation utilities (*)<ol type="i">
<li>IPFS validation<ol type="A">
<li>Parse the CID to get hash &amp; hash algo</li>
<li>Hash the block and check that they match</li>
</ol>
</li>
<li>IPNS validation<ol type="A">
<li>Parse the name as CIDv1, if fails assume DNSLink</li>
<li>Fetch the IPNS name record, see <a href="https://gist.github.com/hacdias/f8935decee0c6a57513f2221c5a2fd7c">https://gist.github.com/hacdias/f8935decee0c6a57513f2221c5a2fd7c</a> for examples.</li>
</ol>
</li>
<li>DNSLink URLs<ol type="A">
<li>Attempt to fetch the TXT record by standard Chromium means</li>
<li>Do the substitution as described <a href="http://chomp:8080/ipfs/bafybeidkrrsdauzr6lfkfr7so625myv7njbzvkptrrj2a4ir4ejlg3sieu/concepts/dnslink/#resolve-dnslink-name">here</a></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md40"></a>
Navigation Request Flow</h2>
<h3><a class="anchor" id="autotoc_md41"></a>
Top-Level</h3>
<div class="fragment"><div class="line">graph TD;</div>
<div class="line">    start([&quot;ChromeContentBrowserClient::WillCreateURLLoaderRequestInterceptors()&quot;])</div>
<div class="line">    style start fill:#9CF,color:black</div>
<div class="line">    start --&quot;(creates)&quot;----&gt; inter[[ipfs::Interceptor]]</div>
<div class="line">    prev[[Previous Interceptor]] --&gt; req0[/&quot;URLRequest(1)&quot;/]</div>
<div class="line">    style req0 fill:#FFE,color:black</div>
<div class="line">    req0 --&gt; inter</div>
<div class="line">    inter --&gt; is_ipfs{&quot;Is scheme ip_s?&quot;}</div>
<div class="line">    is_ipfs --NO--&gt; req1[/&quot;URLRequest(1)&quot;/]</div>
<div class="line">    style req1 fill:#FFE,color:black</div>
<div class="line">    req1 --&gt; next[[&quot;Next Interceptor(not handled)&quot;]]</div>
<div class="line">    is_ipfs --&quot;YES (creates)&quot;--&gt; loader[[&quot;ipfs::Loader(URLLoader)&quot;]]</div>
<div class="line">    state[[&quot;Gateways&quot;]] --&gt; gwlist[/&quot;Prioritized list of gateways&quot;/] --&gt; loader</div>
<div class="line">    style gwlist fill:#FFE,color:black</div>
<div class="line">    req2[/&quot;URLRequest(2)&quot;/] --&quot;Maybe modified, but not scheme&quot;--&gt; loader</div>
<div class="line">    style req2 fill:#FFE,color:black</div>
<div class="line">    errored([&quot;Call back to client code with error&quot;])</div>
<div class="line">    style errored fill:#9CF,color:black</div>
<div class="line">    loader --&gt; is_ipns{&quot;URL Scheme&quot;} --IPNS--&gt; parse_ipns[/&quot;Attempt to parse name as CIDV1&quot;/] --FAIL--&gt; dns_txt[/&quot;Attempt to fetch dnslink= from TXT&quot;/] --FAIL--&gt; errored</div>
<div class="line">    dns_txt --PASS--&gt; dns_sub[&quot;Replace URL prefix based on value&quot;] --&gt; is_ipns</div>
<div class="line">    parse_ipns --PASS--&gt; detnrurl[&quot;Set &#39;Accept: application/vnd.ipfs.ipns-record&#39;&quot;] --&gt; gwreq&gt;&quot;Gateway Request (see next chart)&quot;]</div>
<div class="line">    style gwreq fill:#FDC,color:black</div>
<div class="line">    gwreq --&gt; validate --&gt; sub[&quot;Substitute into URL&quot;] --&gt; is_ipns</div>
<div class="line">    is_ipns --IPFS--&gt; hdr[&quot;Set &#39;Accept: application/vnd.ipld.raw&#39;&quot;] --&gt; gwreq0&gt;&quot;Gateway Request&quot;]</div>
<div class="line">    style gwreq0 fill:#FDC,color:black</div>
<div class="line">    gwreq0 --&gt; v[&quot;validate&quot;] --&gt; store[&quot;Store/append the block if we&#39;re at the end of the path&quot;] --&gt; links{&quot;Are there links in the block?&quot;} --YES--&gt; filtr[&quot;If URL contains path, only follow appropriate DAG links&quot;] --&quot;For Each&quot;--&gt; hdr</div>
<div class="line">    gwreq --ALL FAIL--&gt; errored</div>
<div class="line">    gwreq0 --ALL FAIL--&gt; errored</div>
<div class="line">    links --NO--&gt; reconstitute --&gt; successed([&quot;Call back with status 200 and response body&quot;])</div>
<div class="line">    style successed fill:#9CF,color:black</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md42"></a>
Gateway Request</h3>
<p>The class maintains:</p><ul>
<li>Pending requests: A list where each member has:<ul>
<li>URL suffix (everything after the gateway)</li>
<li>enum/callback for what to do with the response</li>
<li>duplicate count: how many gateways it's been requested from already</li>
</ul>
</li>
<li>A list of gateways marked or segregated based on:<ul>
<li>GOOD/BAD - whether the gateway has returned a successful http response during <em>this</em> class's lifetime yet.</li>
<li>BUSY/FREE - whether an HTTP request to that gateway is outstanding</li>
</ul>
</li>
<li>For each gateway, a set of TaskFailed requests (URL suffixes)</li>
</ul>
<div class="fragment"><div class="line">graph TD;</div>
<div class="line">    start([&quot;URL suffix from above flow&quot;]) --&gt; add[(&quot;Add to pending_ requests&quot;)]</div>
<div class="line">    style start fill:#9CF,color:black</div>
<div class="line">    add --&gt; selreq[&quot;Select the pending_ request with the lowest dup count&quot;] --&gt; incdup[&quot;Increase its dup count&quot;] </div>
<div class="line">    incdup --&gt; goodfree{&quot;Is there a gateway that is both GOOD and FREE&quot;} </div>
<div class="line">    goodfree --NO--&gt; badfree{&quot;Are there any FREE that have not already TaskFailed this request?&quot;} </div>
<div class="line">    badfree --NO--&gt; anybusy{&quot;Are there any BUSY gateways?&quot;} </div>
<div class="line">    anybusy --YES--&gt; wait((&quot;Wait for pending_ requests to finish (return flow control)&quot;))</div>
<div class="line">    badfree --YES--&gt; selbf[&quot;Select the one with the fewest TaskFailed requests, initial parallel tiebreaks&quot;] </div>
<div class="line">    selbf --&gt; mark_busy[&quot;Mark the gateway as BUSY&quot;]</div>
<div class="line">    goodfree --YES--&gt; selbf</div>
<div class="line">    mark_busy --&gt; send[&quot;Create and send an HTTP URLRequest&quot;]</div>
<div class="line">    send -.callback.-&gt; resp</div>
<div class="line">    send --&gt; conc{&quot;Do we have the max concurrent requests already?&quot;} --NO--&gt; selreq</div>
<div class="line">    conc --YES--&gt; wait</div>
<div class="line">    resp[/&quot;URL response&quot;/] --&gt; markfree[&quot;Mark the gateway as FREE&quot;] --&gt; success{&quot;status=200 + body?&quot;} </div>
<div class="line">    style resp fill:#FFE,color:black</div>
<div class="line">    success --YES--&gt; cancel[&quot;Cancel identical requests&quot;] --&gt; markgood[&quot;Mark the gateway as GOOD&quot;] </div>
<div class="line">    markgood --&gt; incprio[&quot;Indicate to Gateways that this gateway&#39;s score/parallel should be a bit higher&quot;] </div>
<div class="line">    incprio ----&gt; successed([&quot;Return response (see previous diagram)&quot;])</div>
<div class="line">    style successed fill:#9CF,color:black</div>
<div class="line">    success --NO--&gt; addbad[&quot;Add the URL suffix to this gateway&#39;s set of failures.&quot;] </div>
<div class="line">    addbad --&gt; decprio[Indicate to Gateways that this gateway&#39;s score/parallel should be a bit lower] --&gt; selreq</div>
<div class="line">    anybusy --NO---&gt; all_failed([&quot;As all gateways have TaskFailed on a given request, report that failure&quot;])</div>
<div class="line">    style all_failed fill:#9CF,color:black</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md43"></a>
Class Diagram</h2>
<div class="fragment"><div class="line">classDiagram</div>
<div class="line">   class ChromeContentBrowserClient {</div>
<div class="line">      WillCreateURLLoaderRequestInterceptors()</div>
<div class="line">      ...</div>
<div class="line">   }</div>
<div class="line">   class ipfs_Loader {</div>
<div class="line">      pending_requests</div>
<div class="line">      gateway_list</div>
<div class="line">      ...</div>
<div class="line">   }</div>
<div class="line">   class Gateways {</div>
<div class="line">      get_list()</div>
<div class="line">      increase_priority()</div>
<div class="line">      decrease_priority()</div>
<div class="line">   }</div>
<div class="line">   ChromeContentBrowserClient ..&gt; ipfs_Interceptor</div>
<div class="line">   ipfs_Interceptor ..&gt; Gateways</div>
<div class="line">   ipfs_Interceptor ..&gt; ipfs_Loader</div>
<div class="line">   ipfs_Loader ..&gt; Gateways   </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
