<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ipfs-chromium: Electron Flavor Tweaks</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ipfs-chromium
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Electron Flavor Tweaks </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md72"></a>
The situation</h1>
<p>Chromium is a powerful project, implementing functionality that's critical to the Web and web-related technologies. Perhaps the greatest credit to its quality and completeness is that fact that it has become an almost defacto-standard. So it's no surprise that other projects would want to inherit much of that codebase.</p>
<p>You can't upstream everything you'd want to do with it, as your needs are not necessarily the needs of everyone everwhere. Chromium would be a chaotic mess if everyone did this, so it's no surprise</p>
<p>It is also very, very active with code changes happening nearly constantly, and some of them quite important. So forking Chromium isn't attractive, since you'd want to benefit from the rest of the community.</p>
<p>This leaves a number of projects in the sometimes-hairy situation of being "downstream", defining their code as a series of patches, file additions, and/or file deletions on top of Chromium's code base. And of course this means a fair amount of work needs to be done to accomodate upstream changes. Electron is in this camp, and as a very active project in its own right they do an excellent job of it.</p>
<p>So what if someone wanted a slightly modified Electron, perhaps adding some feature(s) that are too specific to be in-scope for upstream &ndash; creating their own flavor of Electron? They need to ask themselves a very serious question: are they really going to maintain a project that is a set of patches on top of a rapidly-moving set of patches on top of a rapidly-moving upstream? How difficult is this? Could we make it easier?</p>
<h1><a class="anchor" id="autotoc_md73"></a>
One approach</h1>
<p>What if, instead of upstreaming all our niche changes, we could upstream some extension points to make this process easier?</p>
<p>Adding files wholesale is considerably easier than patching upstream files. We get to skip the merge conflicts, and it might be easier to test them in isolation. So for build-time extension, a build-script could change its behavior based on the presence of a particular file path. That way if you don't change anything you get the normal build behavior, but if you do /electron hooks into your code without you changing anything.</p>
<p>So, on the downstream side this means:</p><ul>
<li>Add a directory for your module, complete with it's own BUILD.gn</li>
<li>Include a source file (header) with a pre-defined name that implements a pre-defined function signature, for each hook you want to use.</li>
</ul>
<p>On the upstream (electron) side, this means:</p><ul>
<li>The build script notes the presence of your BUILD.gn and adds a dependency so it can call into your code</li>
<li>For each pre-defined header file name, if it exists the build script flips a build flag</li>
<li>In the appropriate part of the build, if the compile-time flag is set, it includes your header and compiles a call into your function.</li>
</ul>
<h2><a class="anchor" id="autotoc_md74"></a>
What hooks</h2>
<p>Presumably this would/could change. I haven't imagined every conceivable use case. But I did do a few demonstrations of the technique, and for them I found these sufficient:</p>
<ul>
<li>Immediately after <code>PreMainMessageLoopRun</code>, in case you have initialization to do</li>
<li>Registering additional preferences</li>
<li>Creating URL Loader Request interceptor(s)</li>
<li>Creating sub-resource URL loader factories</li>
<li>List of additional protocol schemes to consider "handled"</li>
</ul>
<h2><a class="anchor" id="autotoc_md75"></a>
Example Demos</h2>
<p>So what demonstrations did I cook up, just to whet your appetite?</p>
<h3><a class="anchor" id="autotoc_md76"></a>
Rendering Markdown</h3>
<p><a href="https://github.com/John-LittleBearLabs/markdown-electron">This</a> spin on Electron uses a URL Loader Request interceptor that kicks in when a user navigates (e.g. clicks a link to) a raw Markdown document. It uses <a href="https://github.com/commonmark/cmark">CMark</a> to convert it to HTML, and renders that.</p>
<p><img src="img/elecmd.png" alt="screenshot" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
